name: CI/CD Pipeline

on:
  workflow_dispatch:  # Only run manually - automatic triggers disabled

defaults:
  run:
    working-directory: wap-backend

jobs:
  # Job 1: Run tests and linting (fast feedback)
  test:
    name: Run Tests & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'wap-backend/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff black
      
      - name: Run linting (Ruff)
        run: |
          ruff check app/ --select E,F,W
        continue-on-error: true
      
      - name: Check code formatting (Black)
        run: |
          black --check app/
        continue-on-error: true
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=app --cov-report=term-missing
        continue-on-error: true
      
      - name: Type checking (mypy)
        run: |
          pip install mypy
          mypy app/ --ignore-missing-imports
        continue-on-error: true

  # Job 2: Build Docker image (validate Dockerfile)
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./wap-backend
          push: false
          tags: swap-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 3: Deploy to Fly.io (only on main branch)
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        working-directory: wap-backend
        run: flyctl deploy --remote-only --ha=false
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Wait for deployment health check
        working-directory: wap-backend
        run: |
          echo "Waiting for app to be healthy..."
          sleep 30
          flyctl status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Smoke test deployed app
        run: |
          curl -f https://swap-backend.fly.dev/healthz || exit 1
          echo "✅ Deployment successful and healthy!"

  # Job 4: Notify on failure (optional)
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "❌ Pipeline failed! Check logs at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

